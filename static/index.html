<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradingView Clone</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Trebuchet MS', Roboto, Ubuntu, sans-serif;
            background-color: #131722;
            color: white;
            overflow: hidden;
        }
        
        .main-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        .content-container {
            display: flex;
            flex: 1;
            min-height: 0;
        }
        
        .chart-container {
            flex: 1;
            position: relative;
            background-color: #131722;
        }
        
        #chart {
            width: 100%;
            height: 100%;
        }
        
        .sidebar {
            width: 320px;
            background-color: #1e222d;
            border-left: 1px solid #363a45;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
        }
        
        .watchlist-section {
            flex: 1;
            overflow-y: auto;
        }
        
        .stock-details-section {
            border-top: 1px solid #363a45;
            background-color: #1e222d;
        }
        
        .navbar {
            height: 48px;
            background-color: #1e222d;
            border-bottom: 1px solid #363a45;
            display: flex;
            align-items: center;
            padding: 0 16px;
            flex-shrink: 0;
        }
        
        .price-bar {
            height: 48px;
            background-color: #1e222d;
            border-bottom: 1px solid #363a45;
            display: flex;
            align-items: center;
            padding: 0 16px;
            flex-shrink: 0;
        }
        
        .footer {
            height: 48px;
            background-color: #1e222d;
            border-top: 1px solid #363a45;
            display: flex;
            align-items: center;
            padding: 0 16px;
            flex-shrink: 0;
        }
        
        .stock-item {
            transition: all 0.15s ease;
            border-bottom: 1px solid #363a45;
        }
        
        .stock-item:hover {
            background-color: #2a2e39;
        }
        
        .stock-item.active {
            background-color: #1e222d;
            border-left: 2px solid #2962ff;
        }

        .rectangle-tool-btn {
            transition: all 0.15s ease;
        }

        .rectangle-tool-btn.active {
            background-color: #2962ff !important;
            color: white !important;
        }
        
        @media (max-width: 1024px) {
            .sidebar {
                width: 280px;
            }
        }
        
        @media (max-width: 768px) {
            .content-container {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                height: 300px;
                border-left: none;
                border-top: 1px solid #363a45;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="navbar">
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-2">
                    <div class="w-6 h-6 bg-orange-500 rounded flex items-center justify-center text-xs font-bold">A</div>
                    <span class="text-white font-medium" id="nav-symbol">AAPL</span>
                    <span class="text-gray-400 text-sm" id="nav-name">Apple Inc.</span>
                    <button class="text-gray-400 hover:text-white">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </button>
                </div>

                <div class="flex items-center space-x-1 ml-8">
                    <button id="rectangle-tool-btn" class="rectangle-tool-btn px-3 py-1 text-sm border border-gray-600 rounded text-gray-300 hover:bg-gray-700" title="Rectangle Selection Tool">
                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V6a2 2 0 012-2h8a2 2 0 012 2v2m0 0v8a2 2 0 01-2 2H6a2 2 0 01-2-2V8m0 0h12"></path>
                        </svg>
                        Rectangle
                    </button>
                </div>

                <button class="px-3 py-1 text-sm border border-gray-600 rounded text-gray-300 hover:bg-gray-700 ml-4">
                    Indicators
                </button>
            </div>

            <div class="ml-auto flex items-center space-x-2">
                <button class="px-3 py-1 text-sm text-gray-300 hover:bg-gray-700 rounded">Alert</button>
                <button class="px-3 py-1 text-sm text-gray-300 hover:bg-gray-700 rounded">Replay</button>
                <button id="chat-btn" class="px-3 py-1 text-sm bg-purple-600 hover:bg-purple-700 rounded text-white hidden" title="Open AI Chat">
                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-3.582 8-8 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 3.582-8 8-8s8 3.582 8 8z"></path>
                    </svg>
                    AI Chat
                </button>
                <button class="px-3 py-1 text-sm bg-blue-600 rounded text-white">Publish</button>
            </div>
        </div>

        <div class="price-bar">
            <div class="flex items-center space-x-6">
                <div class="flex items-center space-x-2">
                    <span class="text-2xl font-medium" id="current-price">Loading...</span>
                    <span class="text-gray-400 text-sm" id="price-change">Loading...</span>
                </div>
                <div class="text-sm text-gray-400">
                    <span>O</span> <span class="text-white" id="open-price">--</span>
                    <span class="ml-3">H</span> <span class="text-white" id="high-price">--</span>
                    <span class="ml-3">L</span> <span class="text-white" id="low-price">--</span>
                    <span class="ml-3">C</span> <span class="text-white" id="close-price">--</span>
                </div>
                <div class="text-sm text-gray-400">
                    Vol <span class="text-white" id="volume">--</span>
                </div>
            </div>
        </div>

        <div class="content-container">
            <div class="chart-container">
                <div id="chart"></div>
            </div>

            <div class="sidebar">
                <div id="normal-sidebar" class="flex flex-col h-full">
                    <div class="watchlist-section">
                        <div class="p-4 border-b border-gray-700">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="text-sm font-medium text-gray-300">Watchlist</h3>
                                <div class="flex items-center space-x-2">
                                    <button class="text-gray-400 hover:text-white">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                        </svg>
                                    </button>
                                    <button class="text-gray-400 hover:text-white">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                        </svg>
                                    </button>
                                    <button class="text-gray-400 hover:text-white">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h.01M12 12h.01M19 12h.01M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-4 gap-4 text-xs text-gray-400 mb-2">
                                <div>Symbol</div>
                                <div class="text-right">Last</div>
                                <div class="text-right">Chg</div>
                                <div class="text-right">Chg%</div>
                            </div>
                        </div>
                        
                        <div class="overflow-y-auto" id="watchlist-items">
                        </div>
                    </div>

                    <div class="stock-details-section">
                        <div class="p-4">
                            <div class="flex items-center space-x-3 mb-3">
                                <div class="w-8 h-8 bg-orange-500 rounded flex items-center justify-center text-sm font-bold" id="details-icon">A</div>
                                <div>
                                    <div class="text-sm font-medium" id="details-symbol">AAPL</div>
                                    <div class="text-xs text-gray-400" id="details-name">Apple Inc.</div>
                                    <div class="text-xs text-gray-400" id="details-sector">Technology</div>
                                </div>
                            </div>

                            <div class="mb-4">
                                <div class="flex items-baseline space-x-2">
                                    <span class="text-2xl font-bold" id="details-price">Loading...</span>
                                    <span class="text-sm text-gray-400">USD</span>
                                    <span class="text-sm" id="details-change">Loading...</span>
                                </div>
                                <div class="flex items-center space-x-1 mt-1">
                                    <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                                    <span class="text-xs text-gray-400">Market data</span>
                                </div>
                            </div>

                            <div>
                                <div class="text-sm font-medium mb-3">Key stats</div>
                                <div class="space-y-2">
                                    <div class="flex justify-between text-sm">
                                        <span class="text-gray-400">Volume</span>
                                        <span id="details-volume">--</span>
                                    </div>
                                    <div class="flex justify-between text-sm">
                                        <span class="text-gray-400">Market capitalization</span>
                                        <span id="details-market-cap">--</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="chat-sidebar" class="flex flex-col h-full hidden">
                    <div class="p-4 border-b border-gray-700">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center space-x-2">
                                <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-3.582 8-8 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 3.582-8 8-8s8 3.582 8 8z"></path>
                                </svg>
                                <h3 class="text-sm font-medium text-gray-300">AI Chat</h3>
                                <span class="text-xs text-gray-500" id="chat-symbol">AAPL</span>
                            </div>
                            <button id="back-btn" class="text-gray-400 hover:text-white" title="Back to Watchlist">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <div id="selection-info" class="mt-3 p-2 bg-gray-800 rounded text-xs text-gray-300 hidden">
                            <div class="flex items-center space-x-1">
                                <svg class="w-3 h-3 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <span>Selected: <span id="selected-range">Jan 2024 - Mar 2024</span></span>
                            </div>
                        </div>
                    </div>

                    <div class="flex-1 overflow-y-auto p-4 space-y-4" id="chat-messages">
                        <div class="text-center text-gray-500 text-sm py-8">
                            <svg class="w-8 h-8 mx-auto mb-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10m0 0V6a2 2 0 00-2-2H9a2 2 0 00-2 2v2m0 0v10a2 2 0 002 2h10a2 2 0 002-2V8M9 12h6"></path>
                            </svg>
                            <p>Draw a rectangle on the chart and press <kbd class="px-1 py-0.5 bg-gray-700 rounded text-xs">⌘L</kbd> to analyze</p>
                            <p class="text-xs mt-1">Or type a question about <span id="chat-stock-name">Apple</span></p>
                        </div>
                    </div>

                    <div class="p-4 border-t border-gray-700">
                        <div class="flex space-x-2">
                            <input 
                                type="text" 
                                id="chat-input" 
                                placeholder="Ask about the selected time period or this stock..."
                                class="flex-1 px-3 py-2 bg-gray-800 border border-gray-600 rounded text-sm text-white placeholder-gray-400 focus:outline-none focus:border-purple-500"
                            >
                            <button id="send-btn" class="px-3 py-2 bg-purple-600 hover:bg-purple-700 rounded text-white text-sm disabled:opacity-50" disabled>
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <div class="flex items-center space-x-1">
                <button class="range-btn px-3 py-1 text-sm rounded text-gray-300 hover:bg-gray-700" data-range="3M">3M</button>
                <button class="range-btn px-3 py-1 text-sm rounded text-gray-300 hover:bg-gray-700" data-range="6M">6M</button>
                <button class="range-btn px-3 py-1 text-sm rounded text-gray-300 hover:bg-gray-700" data-range="YTD">YTD</button>
                <button class="range-btn px-3 py-1 text-sm rounded text-gray-300 hover:bg-gray-700" data-range="1Y">1Y</button>
                <button class="range-btn px-3 py-1 text-sm rounded text-gray-300 hover:bg-gray-700" data-range="ALL">All</button>
            </div>
        </div>
    </div>

    <script>

        class RectangleRenderer {
            constructor(data) {
                this._data = data;
            }

            draw(target) {
                if (!this._data || !this._data.startTime || !this._data.endTime || 
                    this._data.startPrice === null || this._data.endPrice === null) {
                    return;
                }

                target.useBitmapCoordinateSpace(scope => {
                    const ctx = scope.context;

                    const x1 = Math.round(this._data.x1 * scope.horizontalPixelRatio);
                    const x2 = Math.round(this._data.x2 * scope.horizontalPixelRatio);
                    const y1 = Math.round(this._data.y1 * scope.verticalPixelRatio);
                    const y2 = Math.round(this._data.y2 * scope.verticalPixelRatio);

                    const left = Math.min(x1, x2);
                    const right = Math.max(x1, x2);
                    const top = Math.min(y1, y2);
                    const bottom = Math.max(y1, y2);

                    ctx.save();

                    ctx.fillStyle = this._data.fillColor || 'rgba(41, 98, 255, 0.1)';
                    ctx.fillRect(left, top, right - left, bottom - top);

                    ctx.strokeStyle = this._data.borderColor || '#2962ff';
                    ctx.lineWidth = (this._data.borderWidth || 2) * scope.horizontalPixelRatio;
                    ctx.strokeRect(left, top, right - left, bottom - top);

                    ctx.restore();
                });
            }
        }

        class RectanglePaneView {
            constructor(rectangle) {
                this._rectangle = rectangle;
                this._renderer = new RectangleRenderer(rectangle);
            }

            update() {
                this._renderer = new RectangleRenderer(this._rectangle);
            }

            renderer() {
                return this._renderer;
            }

            zOrder() {
                return 'normal';
            }
        }

        class RectangleDrawingPrimitive {
            constructor() {
                this._rectangles = [];
                this._isDrawing = false;
                this._currentRectangle = null;
                this._startPoint = null;
                this._enabled = false;
                this._onRectangleCreated = null;
                this._chart = null;
                this._series = null;
                this._requestUpdate = null;
                this._paneViews = [];
            }

            updateAllViews() {
                this._updatePaneViews();
            }

            paneViews() {
                return this._paneViews;
            }

            attached(param) {
                this._chart = param.chart;
                this._series = param.series;
                this._requestUpdate = param.requestUpdate;
                this._setupEventHandlers();
            }

            detached() {
                this._cleanup();
                this._chart = null;
                this._series = null;
                this._requestUpdate = null;
            }

            priceAxisViews() {
                return [];
            }

            timeAxisViews() {
                return [];
            }


            _updatePaneViews() {
                this._paneViews = [];

                this._rectangles.forEach((rect, index) => {
                    this._updateRectangleCoordinates(rect);
                    if (rect.visible) {
                        this._paneViews.push(new RectanglePaneView(rect));
                    }
                });

                if (this._isDrawing && this._currentRectangle) {
                    this._updateRectangleCoordinates(this._currentRectangle);
                    this._paneViews.push(new RectanglePaneView(this._currentRectangle));
                }
            }

            _updateRectangleCoordinates(rect) {
                if (!this._chart || !this._series || !rect.startTime || !rect.endTime) {
                    rect.visible = false;
                    return;
                }

                const timeScale = this._chart.timeScale();
                const x1 = timeScale.timeToCoordinate(rect.startTime);
                const x2 = timeScale.timeToCoordinate(rect.endTime);
                
                let y1 = null, y2 = null;
                try {
                    y1 = candlestickSeries.priceToCoordinate(rect.startPrice);
                    y2 = candlestickSeries.priceToCoordinate(rect.endPrice);
                } catch (error1) {
                    try {
                        const priceScale = this._series.priceScale();
                        y1 = priceScale.priceToCoordinate(rect.startPrice);
                        y2 = priceScale.priceToCoordinate(rect.endPrice);
                    } catch (error2) {
                        try {
                            y1 = this._chart.priceScale('right').priceToCoordinate(rect.startPrice);
                            y2 = this._chart.priceScale('right').priceToCoordinate(rect.endPrice);
                        } catch (error3) {
                            console.error('ERROR: Price coordinate conversion failed');
                            rect.visible = false;
                            return;
                        }
                    }
                }

                if (x1 === null || x2 === null || y1 === null || y2 === null) {
                    rect.visible = false;
                    return;
                }

                rect.x1 = x1;
                rect.x2 = x2;
                rect.y1 = y1;
                rect.y2 = y2;
                rect.visible = true;
            }

            _setupEventHandlers() {
                if (!this._chart) {
                    console.error('ERROR: No chart available for event handlers');
                    return;
                }

                const chartElement = this._chart.chartElement();
                this._clickHandler = this._onClick.bind(this);
                this._mouseMoveHandler = this._onMouseMove.bind(this);
                this._keyHandler = this._onKeyDown.bind(this);

                chartElement.addEventListener('click', this._clickHandler);
                chartElement.addEventListener('mousemove', this._mouseMoveHandler);
                document.addEventListener('keydown', this._keyHandler);
            }

            _cleanup() {
                if (this._chart) {
                    const chartElement = this._chart.chartElement();
                    if (this._clickHandler) {
                        chartElement.removeEventListener('click', this._clickHandler);
                    }
                    if (this._mouseMoveHandler) {
                        chartElement.removeEventListener('mousemove', this._mouseMoveHandler);
                    }
                }
                if (this._keyHandler) {
                    document.removeEventListener('keydown', this._keyHandler);
                }
            }

            _onClick(event) {
                
                if (!this._enabled) {
                    return;
                }

                event.preventDefault();
                event.stopPropagation();
                

                const rect = this._chart.chartElement().getBoundingClientRect();
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;
                

                const time = this._chart.timeScale().coordinateToTime(x);
                const price = candlestickSeries.coordinateToPrice(y);
                

                if (time === null || price === null) {
                    return;
                }

                
                if (!this._isDrawing) {
                    this._startDrawing({ time, price });
                } else {
                    this._finishDrawing({ time, price });
                }
            }

            _onMouseMove(event) {
                if (!this._enabled || !this._isDrawing || !this._startPoint) return;

                const rect = this._chart.chartElement().getBoundingClientRect();
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;

                const time = this._chart.timeScale().coordinateToTime(x);
                
                let price = null;
                price = candlestickSeries.coordinateToPrice(y);

                if (time === null || price === null) return;

                if (this._currentRectangle) {
                    this._currentRectangle.endTime = time;
                    this._currentRectangle.endPrice = price;
                    this._requestUpdate();
                }
            }

            _onKeyDown(event) {
                if (event.key === 'Escape' && this._isDrawing) {
                    this._cancelDrawing();
                }
            }

            _startDrawing(point) {
                this._isDrawing = true;
                this._startPoint = point;

                this._currentRectangle = {
                    startTime: point.time,
                    startPrice: point.price,
                    endTime: point.time,
                    endPrice: point.price,
                    fillColor: 'rgba(41, 98, 255, 0.1)',
                    borderColor: '#2962ff',
                    borderWidth: 2,
                    visible: true
                };

                this._setCursor('crosshair');
                
                if (this._requestUpdate) {
                    this._requestUpdate();
                } else {
                    console.error('ERROR: No _requestUpdate callback available!');
                }
            }

            _finishDrawing(endPoint) {
                if (!this._isDrawing || !this._startPoint || !this._currentRectangle) return;

                this._currentRectangle.endTime = endPoint.time;
                this._currentRectangle.endPrice = endPoint.price;

                this._rectangles.push({ ...this._currentRectangle });

                if (this._onRectangleCreated) {
                    const timeRange = {
                        from: Math.min(this._currentRectangle.startTime, this._currentRectangle.endTime),
                        to: Math.max(this._currentRectangle.startTime, this._currentRectangle.endTime)
                    };
                    const priceRange = {
                        from: Math.min(this._currentRectangle.startPrice, this._currentRectangle.endPrice),
                        to: Math.max(this._currentRectangle.startPrice, this._currentRectangle.endPrice)
                    };
                    this._onRectangleCreated({ timeRange, priceRange });
                }

                this._isDrawing = false;
                this._startPoint = null;
                this._currentRectangle = null;
                this._setCursor('default');
                this._requestUpdate();
            }

            _cancelDrawing() {
                this._isDrawing = false;
                this._startPoint = null;
                this._currentRectangle = null;
                this._setCursor('default');
                this._requestUpdate();
            }

            _setCursor(cursor) {
                if (this._chart) {
                    this._chart.chartElement().style.cursor = cursor;
                }
            }

            enable(onRectangleCreated) {
                this._enabled = true;
                this._onRectangleCreated = onRectangleCreated;
                this._setCursor('crosshair');
            }

            disable() {
                this._enabled = false;
                this._onRectangleCreated = null;
                if (this._isDrawing) {
                    this._cancelDrawing();
                }
                this._setCursor('default');
            }

            clearRectangles() {
                this._rectangles = [];
                if (this._isDrawing) {
                    this._cancelDrawing();
                }
                this._requestUpdate();
            }

            isEnabled() {
                return this._enabled;
            }
        }

        let chart;
        let candlestickSeries;
        let volumeSeries;
        let rectangleDrawingPrimitive;
        let currentData = [];
        let currentSymbol = 'AAPL';
        let currentRange = null;

        let isChatMode = false;
        let selectedTimeRange = null;
        let rectangleToolEnabled = false;

        const API_BASE = 'http://localhost:8000/api';
        
        const watchlistSymbols = ['AAPL', 'NVDA', 'MSFT', 'GOOGL', 'AMZN', 'TSLA', 'META'];

        const cache = {
            chartData: new Map(),
            quotes: new Map(),
            watchlistData: null,
            watchlistTimestamp: 0
        };

        const CACHE_DURATION = {
            CHART: 30 * 60 * 1000,
            QUOTE: 30 * 1000,
            WATCHLIST: 30 * 1000
        };

        function isCacheValid(timestamp, duration) {
            return Date.now() - timestamp < duration;
        }

        function getCacheKey(symbol) {
            return `${symbol}-daily`;
        }

        async function fetchStockChart(symbol, range = null) {
            const cacheKey = getCacheKey(symbol);
            const cached = cache.chartData.get(cacheKey);
            
            if (cached && isCacheValid(cached.timestamp, CACHE_DURATION.CHART)) {
                console.log(`Using cached chart data for ${cacheKey}`);
                return cached.data;
            }

            try {
                let url = `${API_BASE}/stock/${symbol}/chart`;
                if (range) {
                    url += `?range_period=${range}`;
                }
                
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                
                cache.chartData.set(cacheKey, {
                    data: data,
                    timestamp: Date.now()
                });
                
                return data;
            } catch (error) {
                console.error('ERROR: fetching chart data:', error);
                showNotification('Failed to load chart data. Please try again.', 'error');
                return null;
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-4 py-2 rounded shadow-lg z-50 ${
                type === 'error' ? 'bg-red-600 text-white' :
                type === 'warning' ? 'bg-yellow-600 text-white' :
                type === 'success' ? 'bg-green-600 text-white' :
                'bg-blue-600 text-white'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 5000);
        }

        async function fetchStockQuote(symbol) {
            const cached = cache.quotes.get(symbol);
            
            if (cached && isCacheValid(cached.timestamp, CACHE_DURATION.QUOTE)) {
                return cached.data;
            }

            try {
                const response = await fetch(`${API_BASE}/stock/${symbol}/quote`);
                if (!response.ok) throw new Error('Failed to fetch quote');
                const data = await response.json();
                
                cache.quotes.set(symbol, {
                    data: data,
                    timestamp: Date.now()
                });
                
                return data;
            } catch (error) {
                console.error('ERROR: fetching quote:', error);
                return null;
            }
        }

        async function fetchMultipleQuotes(symbols) {
            if (cache.watchlistData && isCacheValid(cache.watchlistTimestamp, CACHE_DURATION.WATCHLIST)) {
                return cache.watchlistData;
            }

            try {
                const response = await fetch(`${API_BASE}/stocks/quotes?symbols=${symbols.join(',')}`);
                if (!response.ok) throw new Error('Failed to fetch quotes');
                const data = await response.json();
                
                cache.watchlistData = data.quotes;
                cache.watchlistTimestamp = Date.now();
                
                return data.quotes;
            } catch (error) {
                console.error('ERROR: fetching multiple quotes:', error);
                return [];
            }
        }

        function initChart() {
            const container = document.getElementById('chart');
            
            chart = LightweightCharts.createChart(container, {
                width: container.clientWidth,
                height: container.clientHeight,
                layout: {
                    background: { color: '#131722' },
                    textColor: '#d1d4dc',
                },
                grid: {
                    vertLines: { color: '#2B2B43' },
                    horzLines: { color: '#2B2B43' },
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal,
                },
                rightPriceScale: {
                    borderColor: '#485c7b',
                },
                timeScale: {
                    borderColor: '#485c7b',
                    timeVisible: true,
                },
                watermark: {
                    visible: false,
                },
                attributionLogo: false,
            });

            candlestickSeries = chart.addSeries(LightweightCharts.CandlestickSeries, {
                upColor: '#26a69a',
                downColor: '#ef5350',
                borderVisible: false,
                wickUpColor: '#26a69a',
                wickDownColor: '#ef5350',
            });

            volumeSeries = chart.addSeries(LightweightCharts.HistogramSeries, {
                color: '#26a69a',
                priceFormat: { type: 'volume' },
                priceScaleId: 'volume',
                scaleMargins: { top: 0.8, bottom: 0 },
            });
            
            chart.priceScale('volume').applyOptions({
                scaleMargins: {
                    top: 0.8,
                    bottom: 0,
                },
            });

            chart.subscribeCrosshairMove(param => {
                if (param.time) {
                    const data = param.seriesData.get(candlestickSeries);
                    if (data) updatePriceDisplay(data);
                } else {
                    updatePriceDisplay();
                }
            });

            rectangleDrawingPrimitive = new RectangleDrawingPrimitive();
            candlestickSeries.attachPrimitive(rectangleDrawingPrimitive);

            new ResizeObserver(entries => {
                if (entries.length && entries[0].target === container) {
                    const { width, height } = entries[0].contentRect;
                    chart.applyOptions({ width, height });
                }
            }).observe(container);
        }

        function onRectangleCreated(rectangleData) {
            
            selectedTimeRange = {
                startTime: rectangleData.timeRange.from,
                endTime: rectangleData.timeRange.to,
                topPrice: rectangleData.priceRange.to,
                bottomPrice: rectangleData.priceRange.from
            };
            
            showSelection();
            showNotification('Time period selected! Press ⌘L or open chat to analyze.', 'success');
        }

        function toggleRectangleTool() {
            rectangleToolEnabled = !rectangleToolEnabled;
            const btn = document.getElementById('rectangle-tool-btn');
            
            if (rectangleToolEnabled) {
                rectangleDrawingPrimitive.enable(onRectangleCreated);
                btn.classList.add('active');
                btn.classList.remove('text-gray-300', 'hover:bg-gray-700');
                showNotification('Rectangle tool enabled. Click and drag to select time periods.', 'info');
            } else {
                rectangleDrawingPrimitive.disable();
                btn.classList.remove('active');
                btn.classList.add('text-gray-300', 'hover:bg-gray-700');
                showNotification('Rectangle tool disabled.', 'info');
            }
        }

        function clearSelection() {
            selectedTimeRange = null;
            if (rectangleDrawingPrimitive) {
                rectangleDrawingPrimitive.clearRectangles();
            }
            
            const selectionInfo = document.getElementById('selection-info');
            selectionInfo.classList.add('hidden');
            updateSendButton();
        }

        async function loadChart(symbol, range = null) {
            const data = await fetchStockChart(symbol, range);
            if (data) {
                currentData = data.candleData;
                candlestickSeries.setData(data.candleData);
                volumeSeries.setData(data.volumeData);
                
                if (range && data.candleData.length > 0) {
                    setVisibleRangeForPeriod(range, data.candleData);
                } else {
                    chart.timeScale().fitContent();
                }
                
                updatePriceDisplay();
                clearSelection();
            }
        }

        function setVisibleRangeForPeriod(period, data) {
            if (!data || data.length === 0) return;
            
            const now = new Date();
            const latestData = data[data.length - 1];
            const latestTime = latestData.time;
            
            let fromTime;
            
            switch (period) {
                case '3M':
                    fromTime = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
                    break;
                case '6M':
                    fromTime = new Date(now.getTime() - 180 * 24 * 60 * 60 * 1000);
                    break;
                case 'YTD':
                    fromTime = new Date(now.getFullYear(), 0, 1);
                    break;
                case '1Y':
                    fromTime = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000);
                    break;
                case 'ALL':
                default:
                    chart.timeScale().fitContent();
                    return;
            }
            
            try {
                const fromTimestamp = Math.floor(fromTime.getTime() / 1000);
                const toTimestamp = Math.floor(now.getTime() / 1000);
                
                chart.timeScale().setVisibleRange({
                    from: fromTimestamp,
                    to: toTimestamp
                });
            } catch (error) {
                console.warn('WARNING: Could not set visible range, falling back to fit content:', error);
                chart.timeScale().fitContent();
            }
        }

        async function loadStockQuote(symbol) {
            const quote = await fetchStockQuote(symbol);
            if (quote) {
                updateStockDetails(quote);
                updateNavbar(quote);
            }
        }

        function updatePriceDisplay(data = null) {
            if (!currentData.length) return;
            
            const latest = data || currentData[currentData.length - 1];
            const previous = currentData[currentData.length - 2];
            
            if (!latest || !previous) return;
            
            const change = latest.close - previous.close;
            const changePercent = (change / previous.close) * 100;
            
            document.getElementById('current-price').textContent = `$${latest.close.toFixed(2)}`;
            document.getElementById('open-price').textContent = latest.open.toFixed(2);
            document.getElementById('high-price').textContent = latest.high.toFixed(2);
            document.getElementById('low-price').textContent = latest.low.toFixed(2);
            document.getElementById('close-price').textContent = latest.close.toFixed(2);
            
            const changeEl = document.getElementById('price-change');
            const isPositive = change >= 0;
            changeEl.textContent = `${isPositive ? '+' : ''}${change.toFixed(2)} (${isPositive ? '+' : ''}${changePercent.toFixed(2)}%)`;
            changeEl.className = `text-sm ${isPositive ? 'text-green-400' : 'text-red-400'}`;
        }

        function updateStockDetails(quote) {
            document.getElementById('details-symbol').textContent = quote.symbol;
            document.getElementById('details-name').textContent = quote.name;
            document.getElementById('details-sector').textContent = quote.sector;
            document.getElementById('details-price').textContent = quote.price.toFixed(2);
            document.getElementById('details-icon').textContent = quote.symbol.charAt(0);
            
            const isPositive = quote.change >= 0;
            const changeEl = document.getElementById('details-change');
            changeEl.textContent = `${isPositive ? '+' : ''}${quote.change.toFixed(2)} ${isPositive ? '+' : ''}${quote.changePercent.toFixed(2)}%`;
            changeEl.className = `text-sm ${isPositive ? 'text-green-400' : 'text-red-400'}`;
            
            document.getElementById('details-volume').textContent = formatNumber(quote.volume);
            document.getElementById('details-market-cap').textContent = formatNumber(quote.marketCap);
            document.getElementById('volume').textContent = formatNumber(quote.volume);
        }

        function updateNavbar(quote) {
            document.getElementById('nav-symbol').textContent = quote.symbol;
            document.getElementById('nav-name').textContent = quote.name;
        }

        function formatNumber(num) {
            if (num >= 1e12) return (num / 1e12).toFixed(2) + 'T';
            if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
            if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
            if (num >= 1e3) return (num / 1e3).toFixed(2) + 'K';
            return num.toString();
        }

        async function loadWatchlist() {
            const quotes = await fetchMultipleQuotes(watchlistSymbols);
            const container = document.getElementById('watchlist-items');
            
            container.innerHTML = quotes.map((quote, index) => {
                const isPositive = quote.change >= 0;
                const colors = ['bg-orange-500', 'bg-green-500', 'bg-blue-500', 'bg-purple-500', 'bg-yellow-500', 'bg-red-500', 'bg-pink-500'];
                const isActive = quote.symbol === currentSymbol;
                
                return `
                    <div class="stock-item px-4 py-2 cursor-pointer border-l-2 ${isActive ? 'border-blue-500 active' : 'border-transparent hover:border-blue-500'} border-b border-gray-700" data-symbol="${quote.symbol}">
                        <div class="grid grid-cols-4 gap-4 items-center">
                            <div class="flex items-center space-x-2">
                                <div class="w-5 h-5 ${colors[index % colors.length]} rounded flex items-center justify-center text-xs font-bold">${quote.symbol.charAt(0)}</div>
                                <span class="text-sm font-medium">${quote.symbol}</span>
                            </div>
                            <div class="text-right text-sm">${quote.price.toFixed(2)}</div>
                            <div class="text-right text-sm ${isPositive ? 'text-green-400' : 'text-red-400'}">${isPositive ? '+' : ''}${quote.change.toFixed(2)}</div>
                            <div class="text-right text-sm ${isPositive ? 'text-green-400' : 'text-red-400'}">${isPositive ? '+' : ''}${quote.changePercent.toFixed(2)}%</div>
                        </div>
                    </div>
                `;
            }).join('');

            container.querySelectorAll('.stock-item').forEach(item => {
                item.addEventListener('click', () => {
                    const symbol = item.dataset.symbol;
                    if (symbol && symbol !== currentSymbol) {
                        selectStock(symbol);
                    }
                });
            });
        }

        async function selectStock(symbol) {
            currentSymbol = symbol;
            
            document.querySelectorAll('.stock-item').forEach(item => {
                item.classList.remove('active', 'border-blue-500');
                item.classList.add('border-transparent');
            });
            
            const activeItem = document.querySelector(`[data-symbol="${symbol}"]`);
            if (activeItem) {
                activeItem.classList.add('active', 'border-blue-500');
                activeItem.classList.remove('border-transparent');
            }
            
            showChatButton();
            clearSelection();
            
            await Promise.all([
                loadChart(symbol, currentRange),
                loadStockQuote(symbol)
            ]);
        }

        function handleRangeClick(range, buttonElement) {
            document.querySelectorAll('.range-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('text-gray-300');
            });
            
            buttonElement.classList.add('bg-blue-600', 'text-white');
            buttonElement.classList.remove('text-gray-300');
            
            currentRange = range;
            
            loadChart(currentSymbol, currentRange);
        }

        function showChatButton() {
            const chatBtn = document.getElementById('chat-btn');
            if (currentSymbol) {
                chatBtn.classList.remove('hidden');
            }
        }

        function hideChatButton() {
            document.getElementById('chat-btn').classList.add('hidden');
        }

        function toggleChatMode() {
            const normalSidebar = document.getElementById('normal-sidebar');
            const chatSidebar = document.getElementById('chat-sidebar');
            const chatBtn = document.getElementById('chat-btn');
            
            isChatMode = !isChatMode;
            
            if (isChatMode) {
                normalSidebar.classList.add('hidden');
                chatSidebar.classList.remove('hidden');
                chatBtn.innerHTML = '<svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>Back';
                chatBtn.classList.remove('bg-purple-600', 'hover:bg-purple-700');
                chatBtn.classList.add('bg-gray-600', 'hover:bg-gray-700');
                
                document.getElementById('chat-symbol').textContent = currentSymbol;
                document.getElementById('chat-stock-name').textContent = document.getElementById('nav-name').textContent;
                
                setTimeout(() => {
                    document.getElementById('chat-input').focus();
                }, 100);
                
            } else {
                normalSidebar.classList.remove('hidden');
                chatSidebar.classList.add('hidden');
                chatBtn.innerHTML = '<svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-3.582 8-8 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 3.582-8 8-8s8 3.582 8 8z"></path></svg>AI Chat';
                chatBtn.classList.remove('bg-gray-600', 'hover:bg-gray-700');
                chatBtn.classList.add('bg-purple-600', 'hover:bg-purple-700');
            }
        }

        function showSelection() {
            if (!selectedTimeRange) return;
            
            const selectionInfo = document.getElementById('selection-info');
            const selectedRange = document.getElementById('selected-range');
            
            const startDate = new Date(selectedTimeRange.startTime * 1000);
            const endDate = new Date(selectedTimeRange.endTime * 1000);
            
            const formatDate = (date) => {
                return date.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric',
                    year: 'numeric'
                });
            };
            
            const priceRange = `${selectedTimeRange.bottomPrice.toFixed(2)} - ${selectedTimeRange.topPrice.toFixed(2)}`;
            selectedRange.textContent = `${formatDate(startDate)} to ${formatDate(endDate)} • ${priceRange}`;
            selectionInfo.classList.remove('hidden');
            
            updateSendButton();
        }

        function updateSendButton() {
            const sendBtn = document.getElementById('send-btn');
            const chatInput = document.getElementById('chat-input');
            
            const hasText = chatInput.value.trim().length > 0;
            const hasSelection = selectedTimeRange !== null;
            
            sendBtn.disabled = !hasText && !hasSelection;
        }

        function sendChatMessage() {
            const chatInput = document.getElementById('chat-input');
            const message = chatInput.value.trim();
            
            if (!message && !selectedTimeRange) return;
            
            addChatMessage('user', message || 'Analyze the selected time period');
            
            chatInput.value = '';
            updateSendButton();
            
            setTimeout(() => {
                let response = `I'll analyze ${currentSymbol} `;
                if (selectedTimeRange) {
                    const startDate = new Date(selectedTimeRange.startTime * 1000).toLocaleDateString();
                    const endDate = new Date(selectedTimeRange.endTime * 1000).toLocaleDateString();
                    const priceRange = `${selectedTimeRange.bottomPrice.toFixed(2)} to ${selectedTimeRange.topPrice.toFixed(2)}`;
                    response += `during ${startDate} to ${endDate} (price range: ${priceRange}). `;
                }
                response += `Let me gather the relevant news, SEC filings, and price action data for this period...`;
                
                addChatMessage('ai', response);
                
                setTimeout(() => {
                    addChatMessage('ai', '🚧 TODO! This will analyze price movements, news events, and SEC filings for the selected time period.');
                }, 1500);
            }, 500);
        }

        function addChatMessage(type, message) {
            const chatMessages = document.getElementById('chat-messages');
            
            const emptyState = chatMessages.querySelector('.text-center');
            if (emptyState) {
                emptyState.remove();
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${type === 'user' ? 'justify-end' : 'justify-start'}`;
            
            const bubble = document.createElement('div');
            bubble.className = `max-w-xs lg:max-w-md px-3 py-2 rounded-lg text-sm ${
                type === 'user' 
                    ? 'bg-purple-600 text-white' 
                    : 'bg-gray-700 text-gray-200'
            }`;
            bubble.textContent = message;
            
            messageDiv.appendChild(bubble);
            chatMessages.appendChild(messageDiv);
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function handleKeyboardShortcuts(e) {
            if ((e.metaKey || e.ctrlKey) && e.key === 'l') {
                e.preventDefault();
                
                if (selectedTimeRange) {
                    if (!isChatMode) {
                        toggleChatMode();
                    }
                    
                    sendChatMessage();
                } else {
                    showNotification('Draw a rectangle on the chart first using the Rectangle tool', 'warning');
                }
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            initChart();
            
            await Promise.all([
                loadChart(currentSymbol, currentRange),
                loadStockQuote(currentSymbol),
                loadWatchlist()
            ]);
            
            showChatButton();
            
            document.querySelectorAll('.range-btn').forEach(btn => {
                btn.addEventListener('click', () => handleRangeClick(btn.dataset.range, btn));
            });

            document.getElementById('chat-btn').addEventListener('click', toggleChatMode);
            document.getElementById('back-btn').addEventListener('click', toggleChatMode);
            document.getElementById('rectangle-tool-btn').addEventListener('click', toggleRectangleTool);
            
            const chatInput = document.getElementById('chat-input');
            const sendBtn = document.getElementById('send-btn');
            
            chatInput.addEventListener('input', updateSendButton);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !sendBtn.disabled) {
                    sendChatMessage();
                }
            });
            
            sendBtn.addEventListener('click', sendChatMessage);
            
            document.addEventListener('keydown', handleKeyboardShortcuts);

            setInterval(() => {
                loadStockQuote(currentSymbol);
                loadWatchlist();
            }, 30000);
        });
    </script>
</body>
</html>