<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradingView Clone</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Trebuchet MS', Roboto, Ubuntu, sans-serif;
            background-color: #131722;
            color: white;
            overflow: hidden;
        }
        
        .main-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        .content-container {
            display: flex;
            flex: 1;
            min-height: 0;
        }
        
        .chart-container {
            flex: 1;
            position: relative;
            background-color: #131722;
        }
        
        #chart {
            width: 100%;
            height: 100%;
        }
        
        .sidebar {
            width: 320px;
            background-color: #1e222d;
            border-left: 1px solid #363a45;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
        }
        
        .watchlist-section {
            flex: 1;
            overflow-y: auto;
        }
        
        .stock-details-section {
            border-top: 1px solid #363a45;
            background-color: #1e222d;
        }
        
        .navbar {
            height: 48px;
            background-color: #1e222d;
            border-bottom: 1px solid #363a45;
            display: flex;
            align-items: center;
            padding: 0 16px;
            flex-shrink: 0;
        }
        
        .price-bar {
            height: 48px;
            background-color: #1e222d;
            border-bottom: 1px solid #363a45;
            display: flex;
            align-items: center;
            padding: 0 16px;
            flex-shrink: 0;
        }
        
        .footer {
            height: 48px;
            background-color: #1e222d;
            border-top: 1px solid #363a45;
            display: flex;
            align-items: center;
            padding: 0 16px;
            flex-shrink: 0;
        }
        
        .stock-item {
            transition: all 0.15s ease;
            border-bottom: 1px solid #363a45;
        }
        
        .stock-item:hover {
            background-color: #2a2e39;
        }
        
        .stock-item.active {
            background-color: #1e222d;
            border-left: 2px solid #2962ff;
        }
        
        @media (max-width: 1024px) {
            .sidebar {
                width: 280px;
            }
        }
        
        @media (max-width: 768px) {
            .content-container {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                height: 300px;
                border-left: none;
                border-top: 1px solid #363a45;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="navbar">
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-2">
                    <div class="w-6 h-6 bg-orange-500 rounded flex items-center justify-center text-xs font-bold">A</div>
                    <span class="text-white font-medium" id="nav-symbol">AAPL</span>
                    <span class="text-gray-400 text-sm" id="nav-name">Apple Inc.</span>
                    <button class="text-gray-400 hover:text-white">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </button>
                </div>

                <div class="flex items-center space-x-1 ml-8">
                    <!-- Removed all timeframe buttons - only using daily candlesticks now -->
                </div>

                <button class="px-3 py-1 text-sm border border-gray-600 rounded text-gray-300 hover:bg-gray-700 ml-4">
                    Indicators
                </button>
            </div>

            <div class="ml-auto flex items-center space-x-2">
                <button class="px-3 py-1 text-sm text-gray-300 hover:bg-gray-700 rounded">Alert</button>
                <button class="px-3 py-1 text-sm text-gray-300 hover:bg-gray-700 rounded">Replay</button>
                <button id="chat-btn" class="px-3 py-1 text-sm bg-purple-600 hover:bg-purple-700 rounded text-white hidden" title="Open AI Chat">
                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-3.582 8-8 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 3.582-8 8-8s8 3.582 8 8z"></path>
                    </svg>
                    AI Chat
                </button>
                <button class="px-3 py-1 text-sm bg-blue-600 rounded text-white">Publish</button>
            </div>
        </div>

        <div class="price-bar">
            <div class="flex items-center space-x-6">
                <div class="flex items-center space-x-2">
                    <span class="text-2xl font-medium" id="current-price">Loading...</span>
                    <span class="text-gray-400 text-sm" id="price-change">Loading...</span>
                </div>
                <div class="text-sm text-gray-400">
                    <span>O</span> <span class="text-white" id="open-price">--</span>
                    <span class="ml-3">H</span> <span class="text-white" id="high-price">--</span>
                    <span class="ml-3">L</span> <span class="text-white" id="low-price">--</span>
                    <span class="ml-3">C</span> <span class="text-white" id="close-price">--</span>
                </div>
                <div class="text-sm text-gray-400">
                    Vol <span class="text-white" id="volume">--</span>
                </div>
            </div>
        </div>

        <div class="content-container">
            <div class="chart-container">
                <div id="chart"></div>
            </div>

            <div class="sidebar">
                <!-- Normal Mode: Watchlist + Stock Details -->
                <div id="normal-sidebar" class="flex flex-col h-full">
                    <div class="watchlist-section">
                        <div class="p-4 border-b border-gray-700">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="text-sm font-medium text-gray-300">Watchlist</h3>
                                <div class="flex items-center space-x-2">
                                    <button class="text-gray-400 hover:text-white">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                        </svg>
                                    </button>
                                    <button class="text-gray-400 hover:text-white">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                        </svg>
                                    </button>
                                    <button class="text-gray-400 hover:text-white">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h.01M12 12h.01M19 12h.01M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-4 gap-4 text-xs text-gray-400 mb-2">
                                <div>Symbol</div>
                                <div class="text-right">Last</div>
                                <div class="text-right">Chg</div>
                                <div class="text-right">Chg%</div>
                            </div>
                        </div>
                        
                        <div class="overflow-y-auto" id="watchlist-items">
                            <!-- Watchlist items will be populated by JavaScript -->
                        </div>
                    </div>

                    <div class="stock-details-section">
                        <div class="p-4">
                            <div class="flex items-center space-x-3 mb-3">
                                <div class="w-8 h-8 bg-orange-500 rounded flex items-center justify-center text-sm font-bold" id="details-icon">A</div>
                                <div>
                                    <div class="text-sm font-medium" id="details-symbol">AAPL</div>
                                    <div class="text-xs text-gray-400" id="details-name">Apple Inc.</div>
                                    <div class="text-xs text-gray-400" id="details-sector">Technology</div>
                                </div>
                            </div>

                            <div class="mb-4">
                                <div class="flex items-baseline space-x-2">
                                    <span class="text-2xl font-bold" id="details-price">Loading...</span>
                                    <span class="text-sm text-gray-400">USD</span>
                                    <span class="text-sm" id="details-change">Loading...</span>
                                </div>
                                <div class="flex items-center space-x-1 mt-1">
                                    <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                                    <span class="text-xs text-gray-400">Market data</span>
                                </div>
                            </div>

                            <div>
                                <div class="text-sm font-medium mb-3">Key stats</div>
                                <div class="space-y-2">
                                    <div class="flex justify-between text-sm">
                                        <span class="text-gray-400">Volume</span>
                                        <span id="details-volume">--</span>
                                    </div>
                                    <div class="flex justify-between text-sm">
                                        <span class="text-gray-400">Market capitalization</span>
                                        <span id="details-market-cap">--</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat Mode: AI Chat Panel -->
                <div id="chat-sidebar" class="flex flex-col h-full hidden">
                    <!-- Chat Header -->
                    <div class="p-4 border-b border-gray-700">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center space-x-2">
                                <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-3.582 8-8 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 3.582-8 8-8s8 3.582 8 8z"></path>
                                </svg>
                                <h3 class="text-sm font-medium text-gray-300">AI Chat</h3>
                                <span class="text-xs text-gray-500" id="chat-symbol">AAPL</span>
                            </div>
                            <button id="back-btn" class="text-gray-400 hover:text-white" title="Back to Watchlist">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <!-- Selection Info -->
                        <div id="selection-info" class="mt-3 p-2 bg-gray-800 rounded text-xs text-gray-300 hidden">
                            <div class="flex items-center space-x-1">
                                <svg class="w-3 h-3 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <span>Selected: <span id="selected-range">Jan 2024 - Mar 2024</span></span>
                            </div>
                        </div>
                    </div>

                    <!-- Chat Messages -->
                    <div class="flex-1 overflow-y-auto p-4 space-y-4" id="chat-messages">
                        <div class="text-center text-gray-500 text-sm py-8">
                            <svg class="w-8 h-8 mx-auto mb-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10m0 0V6a2 2 0 00-2-2H9a2 2 0 00-2 2v2m0 0v10a2 2 0 002 2h10a2 2 0 002-2V8M9 12h6"></path>
                            </svg>
                            <p>Select a time period on the chart (drag) and press <kbd class="px-1 py-0.5 bg-gray-700 rounded text-xs">⌘L</kbd> to analyze</p>
                            <p class="text-xs mt-1">Or type a question about <span id="chat-stock-name">Apple</span></p>
                        </div>
                    </div>

                    <!-- Chat Input -->
                    <div class="p-4 border-t border-gray-700">
                        <div class="flex space-x-2">
                            <input 
                                type="text" 
                                id="chat-input" 
                                placeholder="Ask about the selected time period or this stock..."
                                class="flex-1 px-3 py-2 bg-gray-800 border border-gray-600 rounded text-sm text-white placeholder-gray-400 focus:outline-none focus:border-purple-500"
                            >
                            <button id="send-btn" class="px-3 py-2 bg-purple-600 hover:bg-purple-700 rounded text-white text-sm disabled:opacity-50" disabled>
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <div class="flex items-center space-x-1">
                <button class="range-btn px-3 py-1 text-sm rounded text-gray-300 hover:bg-gray-700" data-range="3M">3M</button>
                <button class="range-btn px-3 py-1 text-sm rounded text-gray-300 hover:bg-gray-700" data-range="6M">6M</button>
                <button class="range-btn px-3 py-1 text-sm rounded text-gray-300 hover:bg-gray-700" data-range="YTD">YTD</button>
                <button class="range-btn px-3 py-1 text-sm rounded text-gray-300 hover:bg-gray-700" data-range="1Y">1Y</button>
                <button class="range-btn px-3 py-1 text-sm rounded text-gray-300 hover:bg-gray-700" data-range="ALL">All</button>
            </div>
        </div>
    </div>

    <script>
        let chart;
        let candlestickSeries;
        let volumeSeries;
        let currentData = [];
        let currentSymbol = 'AAPL';
        let currentRange = null;

        let isChatMode = false;
        let selectedTimeRange = null;
        let isSelectingMode = false;
        let firstClickPoint = null;
        let selectionOverlay = null;

        const API_BASE = 'http://localhost:8000/api';
        
        const watchlistSymbols = ['AAPL', 'NVDA', 'MSFT', 'GOOGL', 'AMZN', 'TSLA', 'META'];

        const cache = {
            chartData: new Map(), // key: symbol -> {data, timestamp}
            quotes: new Map(),
            watchlistData: null,
            watchlistTimestamp: 0
        };

        const CACHE_DURATION = {
            CHART: 30 * 60 * 1000, // 30 minutes for complete chart data
            QUOTE: 30 * 1000,      // 30 seconds for quotes
            WATCHLIST: 30 * 1000   // 30 seconds for watchlist
        };

        function isCacheValid(timestamp, duration) {
            return Date.now() - timestamp < duration;
        }

        function getCacheKey(symbol) {
            return `${symbol}-daily`;
        }

        async function fetchStockChart(symbol, range = null) {
            const cacheKey = getCacheKey(symbol);
            const cached = cache.chartData.get(cacheKey);
            
            if (cached && isCacheValid(cached.timestamp, CACHE_DURATION.CHART)) {
                console.log(`Using cached chart data for ${cacheKey}`);
                return cached.data;
            }

            try {
                let url = `${API_BASE}/stock/${symbol}/chart`;
                if (range) {
                    url += `?range_period=${range}`;
                }
                
                console.log(`Fetching chart data: ${url}`);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                console.log(`Received ${data.candleData?.length || 0} candles, data type: ${data.dataType || 'unknown'}`);
                
                cache.chartData.set(cacheKey, {
                    data: data,
                    timestamp: Date.now()
                });
                
                return data;
            } catch (error) {
                console.error('Error fetching chart data:', error);
                showNotification('Failed to load chart data. Please try again.', 'error');
                return null;
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-4 py-2 rounded shadow-lg z-50 ${
                type === 'error' ? 'bg-red-600 text-white' :
                type === 'warning' ? 'bg-yellow-600 text-white' :
                type === 'success' ? 'bg-green-600 text-white' :
                'bg-blue-600 text-white'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 5000);
        }

        async function fetchStockQuote(symbol) {
            const cached = cache.quotes.get(symbol);
            
            if (cached && isCacheValid(cached.timestamp, CACHE_DURATION.QUOTE)) {
                console.log(`Using cached quote for ${symbol}`);
                return cached.data;
            }

            try {
                const response = await fetch(`${API_BASE}/stock/${symbol}/quote`);
                if (!response.ok) throw new Error('Failed to fetch quote');
                const data = await response.json();
                
                cache.quotes.set(symbol, {
                    data: data,
                    timestamp: Date.now()
                });
                
                return data;
            } catch (error) {
                console.error('Error fetching quote:', error);
                return null;
            }
        }

        async function fetchMultipleQuotes(symbols) {
            if (cache.watchlistData && isCacheValid(cache.watchlistTimestamp, CACHE_DURATION.WATCHLIST)) {
                console.log('Using cached watchlist data');
                return cache.watchlistData;
            }

            try {
                const response = await fetch(`${API_BASE}/stocks/quotes?symbols=${symbols.join(',')}`);
                if (!response.ok) throw new Error('Failed to fetch quotes');
                const data = await response.json();
                
                cache.watchlistData = data.quotes;
                cache.watchlistTimestamp = Date.now();
                
                return data.quotes;
            } catch (error) {
                console.error('Error fetching multiple quotes:', error);
                return [];
            }
        }

        function initChart() {
            const container = document.getElementById('chart');
            
            chart = LightweightCharts.createChart(container, {
                width: container.clientWidth,
                height: container.clientHeight,
                layout: {
                    background: { color: '#131722' },
                    textColor: '#d1d4dc',
                },
                grid: {
                    vertLines: { color: '#2B2B43' },
                    horzLines: { color: '#2B2B43' },
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal,
                },
                rightPriceScale: {
                    borderColor: '#485c7b',
                },
                timeScale: {
                    borderColor: '#485c7b',
                    timeVisible: true,
                },
                watermark: {
                    visible: false,
                },
                attributionLogo: false,
            });

            candlestickSeries = chart.addSeries(LightweightCharts.CandlestickSeries, {
                upColor: '#26a69a',
                downColor: '#ef5350',
                borderVisible: false,
                wickUpColor: '#26a69a',
                wickDownColor: '#ef5350',
            });

            volumeSeries = chart.addSeries(LightweightCharts.HistogramSeries, {
                color: '#26a69a',
                priceFormat: { type: 'volume' },
                priceScaleId: 'volume',
                scaleMargins: { top: 0.8, bottom: 0 },
            });
            
            chart.priceScale('volume').applyOptions({
                scaleMargins: {
                    top: 0.8,
                    bottom: 0,
                },
            });

            chart.subscribeCrosshairMove(param => {
                if (param.time) {
                    const data = param.seriesData.get(candlestickSeries);
                    if (data) updatePriceDisplay(data);
                } else {
                    updatePriceDisplay();
                }
            });

            new ResizeObserver(entries => {
                if (entries.length && entries[0].target === container) {
                    const { width, height } = entries[0].contentRect;
                    chart.applyOptions({ width, height });
                }
            }).observe(container);
        }

        async function loadChart(symbol, range = null) {
            console.log(`Loading chart for ${symbol}, range: ${range}`);
            
            const data = await fetchStockChart(symbol, range);
            if (data) {
                currentData = data.candleData;
                candlestickSeries.setData(data.candleData);
                volumeSeries.setData(data.volumeData);
                
                if (range && data.candleData.length > 0) {
                    setVisibleRangeForPeriod(range, data.candleData);
                } else {
                    chart.timeScale().fitContent();
                }
                
                updatePriceDisplay();
            }
        }

        function setVisibleRangeForPeriod(period, data) {
            if (!data || data.length === 0) return;
            
            const now = new Date();
            const latestData = data[data.length - 1];
            const latestTime = latestData.time;
            
            let fromTime;
            
            switch (period) {
                case '3M':
                    fromTime = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
                    break;
                case '6M':
                    fromTime = new Date(now.getTime() - 180 * 24 * 60 * 60 * 1000);
                    break;
                case 'YTD':
                    fromTime = new Date(now.getFullYear(), 0, 1);
                    break;
                case '1Y':
                    fromTime = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000);
                    break;
                case 'ALL':
                default:
                    chart.timeScale().fitContent();
                    return;
            }
            
            try {
                const fromTimestamp = Math.floor(fromTime.getTime() / 1000);
                const toTimestamp = Math.floor(now.getTime() / 1000);
                
                chart.timeScale().setVisibleRange({
                    from: fromTimestamp,
                    to: toTimestamp
                });
            } catch (error) {
                console.warn('Could not set visible range, falling back to fit content:', error);
                chart.timeScale().fitContent();
            }
        }

        async function loadStockQuote(symbol) {
            const quote = await fetchStockQuote(symbol);
            if (quote) {
                updateStockDetails(quote);
                updateNavbar(quote);
            }
        }

        function updatePriceDisplay(data = null) {
            if (!currentData.length) return;
            
            const latest = data || currentData[currentData.length - 1];
            const previous = currentData[currentData.length - 2];
            
            if (!latest || !previous) return;
            
            const change = latest.close - previous.close;
            const changePercent = (change / previous.close) * 100;
            
            document.getElementById('current-price').textContent = `$${latest.close.toFixed(2)}`;
            document.getElementById('open-price').textContent = latest.open.toFixed(2);
            document.getElementById('high-price').textContent = latest.high.toFixed(2);
            document.getElementById('low-price').textContent = latest.low.toFixed(2);
            document.getElementById('close-price').textContent = latest.close.toFixed(2);
            
            const changeEl = document.getElementById('price-change');
            const isPositive = change >= 0;
            changeEl.textContent = `${isPositive ? '+' : ''}${change.toFixed(2)} (${isPositive ? '+' : ''}${changePercent.toFixed(2)}%)`;
            changeEl.className = `text-sm ${isPositive ? 'text-green-400' : 'text-red-400'}`;
        }

        function updateStockDetails(quote) {
            document.getElementById('details-symbol').textContent = quote.symbol;
            document.getElementById('details-name').textContent = quote.name;
            document.getElementById('details-sector').textContent = quote.sector;
            document.getElementById('details-price').textContent = quote.price.toFixed(2);
            document.getElementById('details-icon').textContent = quote.symbol.charAt(0);
            
            const isPositive = quote.change >= 0;
            const changeEl = document.getElementById('details-change');
            changeEl.textContent = `${isPositive ? '+' : ''}${quote.change.toFixed(2)} ${isPositive ? '+' : ''}${quote.changePercent.toFixed(2)}%`;
            changeEl.className = `text-sm ${isPositive ? 'text-green-400' : 'text-red-400'}`;
            
            document.getElementById('details-volume').textContent = formatNumber(quote.volume);
            document.getElementById('details-market-cap').textContent = formatNumber(quote.marketCap);
            document.getElementById('volume').textContent = formatNumber(quote.volume);
        }

        function updateNavbar(quote) {
            document.getElementById('nav-symbol').textContent = quote.symbol;
            document.getElementById('nav-name').textContent = quote.name;
        }

        function formatNumber(num) {
            if (num >= 1e12) return (num / 1e12).toFixed(2) + 'T';
            if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
            if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
            if (num >= 1e3) return (num / 1e3).toFixed(2) + 'K';
            return num.toString();
        }

        async function loadWatchlist() {
            const quotes = await fetchMultipleQuotes(watchlistSymbols);
            const container = document.getElementById('watchlist-items');
            
            container.innerHTML = quotes.map((quote, index) => {
                const isPositive = quote.change >= 0;
                const colors = ['bg-orange-500', 'bg-green-500', 'bg-blue-500', 'bg-purple-500', 'bg-yellow-500', 'bg-red-500', 'bg-pink-500'];
                const isActive = quote.symbol === currentSymbol;
                
                return `
                    <div class="stock-item px-4 py-2 cursor-pointer border-l-2 ${isActive ? 'border-blue-500 active' : 'border-transparent hover:border-blue-500'} border-b border-gray-700" data-symbol="${quote.symbol}">
                        <div class="grid grid-cols-4 gap-4 items-center">
                            <div class="flex items-center space-x-2">
                                <div class="w-5 h-5 ${colors[index % colors.length]} rounded flex items-center justify-center text-xs font-bold">${quote.symbol.charAt(0)}</div>
                                <span class="text-sm font-medium">${quote.symbol}</span>
                            </div>
                            <div class="text-right text-sm">${quote.price.toFixed(2)}</div>
                            <div class="text-right text-sm ${isPositive ? 'text-green-400' : 'text-red-400'}">${isPositive ? '+' : ''}${quote.change.toFixed(2)}</div>
                            <div class="text-right text-sm ${isPositive ? 'text-green-400' : 'text-red-400'}">${isPositive ? '+' : ''}${quote.changePercent.toFixed(2)}%</div>
                        </div>
                    </div>
                `;
            }).join('');

            container.querySelectorAll('.stock-item').forEach(item => {
                item.addEventListener('click', () => {
                    const symbol = item.dataset.symbol;
                    if (symbol && symbol !== currentSymbol) {
                        selectStock(symbol);
                    }
                });
            });
        }

        async function selectStock(symbol) {
            currentSymbol = symbol;
            
            document.querySelectorAll('.stock-item').forEach(item => {
                item.classList.remove('active', 'border-blue-500');
                item.classList.add('border-transparent');
            });
            
            const activeItem = document.querySelector(`[data-symbol="${symbol}"]`);
            if (activeItem) {
                activeItem.classList.add('active', 'border-blue-500');
                activeItem.classList.remove('border-transparent');
            }
            
            showChatButton();
            
            await Promise.all([
                loadChart(symbol, currentRange),
                loadStockQuote(symbol)
            ]);
        }

        function handleRangeClick(range, buttonElement) {
            document.querySelectorAll('.range-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('text-gray-300');
            });
            
            buttonElement.classList.add('bg-blue-600', 'text-white');
            buttonElement.classList.remove('text-gray-300');
            
            currentRange = range;
            
            loadChart(currentSymbol, currentRange);
        }


        function showChatButton() {
            const chatBtn = document.getElementById('chat-btn');
            if (currentSymbol) {
                chatBtn.classList.remove('hidden');
            }
        }

        function hideChatButton() {
            document.getElementById('chat-btn').classList.add('hidden');
        }

        function toggleChatMode() {
            const normalSidebar = document.getElementById('normal-sidebar');
            const chatSidebar = document.getElementById('chat-sidebar');
            const chatBtn = document.getElementById('chat-btn');
            
            isChatMode = !isChatMode;
            
            if (isChatMode) {
                normalSidebar.classList.add('hidden');
                chatSidebar.classList.remove('hidden');
                chatBtn.innerHTML = '<svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>Back';
                chatBtn.classList.remove('bg-purple-600', 'hover:bg-purple-700');
                chatBtn.classList.add('bg-gray-600', 'hover:bg-gray-700');
                
                document.getElementById('chat-symbol').textContent = currentSymbol;
                document.getElementById('chat-stock-name').textContent = document.getElementById('nav-name').textContent;
                
                setTimeout(() => {
                    document.getElementById('chat-input').focus();
                }, 100);
                
            } else {
                normalSidebar.classList.remove('hidden');
                chatSidebar.classList.add('hidden');
                chatBtn.innerHTML = '<svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-3.582 8-8 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 3.582-8 8-8s8 3.582 8 8z"></path></svg>AI Chat';
                chatBtn.classList.remove('bg-gray-600', 'hover:bg-gray-700');
                chatBtn.classList.add('bg-purple-600', 'hover:bg-purple-700');
            }
        }

        function enableChartSelection() {
            if (!chart) return;
            
            const container = document.getElementById('chart');
            
            if (!document.getElementById('selection-styles')) {
                const style = document.createElement('style');
                style.id = 'selection-styles';
                style.textContent = `
                    .chart-selection-overlay {
                        position: absolute;
                        border: 2px solid #2962ff;
                        background-color: rgba(41, 98, 255, 0.1);
                        pointer-events: none;
                        z-index: 1000;
                    }
                `;
                document.head.appendChild(style);
            }
            
            container.addEventListener('click', (e) => {
                if (!e.shiftKey) return;
                
                e.preventDefault();
                
                const rect = container.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                if (!isSelectingMode) {
                    startRectangleSelection(x, y, container);
                } else {
                    completeRectangleSelection(x, y, container);
                }
            });
            
            container.addEventListener('mousemove', (e) => {
                if (isSelectingMode && firstClickPoint && selectionOverlay) {
                    const rect = container.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    updateSelectionOverlay(x, y);
                }
            });
            
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && isSelectingMode) {
                    cancelSelection();
                }
            });
        }

        function startRectangleSelection(x, y, container) {
            isSelectingMode = true;
            firstClickPoint = { x, y };
            
            selectionOverlay = document.createElement('div');
            selectionOverlay.className = 'chart-selection-overlay';
            selectionOverlay.style.left = x + 'px';
            selectionOverlay.style.top = y + 'px';
            selectionOverlay.style.width = '0px';
            selectionOverlay.style.height = '0px';
            
            container.style.position = 'relative';
            container.appendChild(selectionOverlay);
            
            container.style.cursor = 'crosshair';
            
            showNotification('Selection started. Click again to complete the rectangle.', 'info');
        }

        function updateSelectionOverlay(currentX, currentY) {
            if (!selectionOverlay || !firstClickPoint) return;
            
            const left = Math.min(firstClickPoint.x, currentX);
            const top = Math.min(firstClickPoint.y, currentY);
            const width = Math.abs(currentX - firstClickPoint.x);
            const height = Math.abs(currentY - firstClickPoint.y);
            
            selectionOverlay.style.left = left + 'px';
            selectionOverlay.style.top = top + 'px';
            selectionOverlay.style.width = width + 'px';
            selectionOverlay.style.height = height + 'px';
        }

        function completeRectangleSelection(x, y, container) {
            if (!firstClickPoint || !selectionOverlay) return;
            
            const left = Math.min(firstClickPoint.x, x);
            const right = Math.max(firstClickPoint.x, x);
            const top = Math.min(firstClickPoint.y, y);
            const bottom = Math.max(firstClickPoint.y, y);
            
            const startTime = chart.timeScale().coordinateToTime(left);
            const endTime = chart.timeScale().coordinateToTime(right);
            const topPrice = candlestickSeries.coordinateToPrice(top);
            const bottomPrice = candlestickSeries.coordinateToPrice(bottom);
            
            if (Math.abs(right - left) > 50 && Math.abs(bottom - top) > 20 && startTime && endTime) {
                selectedTimeRange = {
                    startTime: Math.min(startTime, endTime),
                    endTime: Math.max(startTime, endTime),
                    topPrice: Math.max(topPrice, bottomPrice),
                    bottomPrice: Math.min(topPrice, bottomPrice),
                    coordinates: { left, right, top, bottom }
                };
                
                selectionOverlay.style.borderColor = '#00ff88';
                selectionOverlay.style.backgroundColor = 'rgba(0, 255, 136, 0.15)';
                
                showSelection();
                showNotification('Time period selected! Press ⌘L or open chat to analyze.', 'success');
            } else {
                showNotification('Selection too small. Try selecting a larger area.', 'warning');
                removeSelectionOverlay();
            }
            
            isSelectingMode = false;
            firstClickPoint = null;
            container.style.cursor = 'default';
        }

        function cancelSelection() {
            if (isSelectingMode) {
                removeSelectionOverlay();
                isSelectingMode = false;
                firstClickPoint = null;
                document.getElementById('chart').style.cursor = 'default';
                showNotification('Selection cancelled.', 'info');
            }
        }

        function removeSelectionOverlay() {
            if (selectionOverlay) {
                selectionOverlay.remove();
                selectionOverlay = null;
            }
        }

        function clearSelection() {
            selectedTimeRange = null;
            removeSelectionOverlay();
            
            const selectionInfo = document.getElementById('selection-info');
            selectionInfo.classList.add('hidden');
            updateSendButton();
        }

        function showSelection() {
            if (!selectedTimeRange) return;
            
            const selectionInfo = document.getElementById('selection-info');
            const selectedRange = document.getElementById('selected-range');
            
            const startDate = new Date(selectedTimeRange.startTime * 1000);
            const endDate = new Date(selectedTimeRange.endTime * 1000);
            
            const formatDate = (date) => {
                return date.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric',
                    year: 'numeric'
                });
            };
            
            const priceRange = `${selectedTimeRange.bottomPrice.toFixed(2)} - ${selectedTimeRange.topPrice.toFixed(2)}`;
            selectedRange.textContent = `${formatDate(startDate)} to ${formatDate(endDate)} • ${priceRange}`;
            selectionInfo.classList.remove('hidden');
            
            updateSendButton();
        }

        function showSelectionInfo() {
            if (selectedTimeRange && isChatMode) {
                showNotification('Time period selected! Press ⌘L or type your question.', 'info');
            }
        }

        function updateSendButton() {
            const sendBtn = document.getElementById('send-btn');
            const chatInput = document.getElementById('chat-input');
            
            const hasText = chatInput.value.trim().length > 0;
            const hasSelection = selectedTimeRange !== null;
            
            sendBtn.disabled = !hasText && !hasSelection;
        }

        function sendChatMessage() {
            const chatInput = document.getElementById('chat-input');
            const message = chatInput.value.trim();
            
            if (!message && !selectedTimeRange) return;
            
            addChatMessage('user', message || 'Analyze the selected time period');
            
            chatInput.value = '';
            updateSendButton();
            
            setTimeout(() => {
                let response = `I'll analyze ${currentSymbol} `;
                if (selectedTimeRange) {
                    const startDate = new Date(selectedTimeRange.startTime * 1000).toLocaleDateString();
                    const endDate = new Date(selectedTimeRange.endTime * 1000).toLocaleDateString();
                    const priceRange = `${selectedTimeRange.bottomPrice.toFixed(2)} to ${selectedTimeRange.topPrice.toFixed(2)}`;
                    response += `during ${startDate} to ${endDate} (price range: ${priceRange}). `;
                }
                response += `Let me gather the relevant news, SEC filings, and price action data for this period...`;
                
                addChatMessage('ai', response);
                
                // to be replaced with actual api call
                setTimeout(() => {
                    addChatMessage('ai', '🚧 TODO! This will analyze price movements, news events, and SEC filings for the selected time period.');
                }, 1500);
            }, 500);
        }

        function addChatMessage(type, message) {
            const chatMessages = document.getElementById('chat-messages');
            
            const emptyState = chatMessages.querySelector('.text-center');
            if (emptyState) {
                emptyState.remove();
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${type === 'user' ? 'justify-end' : 'justify-start'}`;
            
            const bubble = document.createElement('div');
            bubble.className = `max-w-xs lg:max-w-md px-3 py-2 rounded-lg text-sm ${
                type === 'user' 
                    ? 'bg-purple-600 text-white' 
                    : 'bg-gray-700 text-gray-200'
            }`;
            bubble.textContent = message;
            
            messageDiv.appendChild(bubble);
            chatMessages.appendChild(messageDiv);
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function handleKeyboardShortcuts(e) {
            if ((e.metaKey || e.ctrlKey) && e.key === 'l') {
                e.preventDefault();
                
                if (selectedTimeRange) {
                    if (!isChatMode) {
                        toggleChatMode();
                    }
                    
                    sendChatMessage();
                } else {
                    showNotification('Select a time period on the chart first (drag to select)', 'warning');
                }
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            initChart();
            
            await Promise.all([
                loadChart(currentSymbol, currentRange),
                loadStockQuote(currentSymbol),
                loadWatchlist()
            ]);
            
            showChatButton();
            
            document.querySelectorAll('.range-btn').forEach(btn => {
                btn.addEventListener('click', () => handleRangeClick(btn.dataset.range, btn));
            });

            document.getElementById('chat-btn').addEventListener('click', toggleChatMode);
            document.getElementById('back-btn').addEventListener('click', toggleChatMode);
            
            const chatInput = document.getElementById('chat-input');
            const sendBtn = document.getElementById('send-btn');
            
            chatInput.addEventListener('input', updateSendButton);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !sendBtn.disabled) {
                    sendChatMessage();
                }
            });
            
            sendBtn.addEventListener('click', sendChatMessage);
            
            document.addEventListener('keydown', handleKeyboardShortcuts);
            
            enableChartSelection();

            setInterval(() => {
                loadStockQuote(currentSymbol);
                loadWatchlist();
            }, 30000);
        });
    </script>
</body>
</html>